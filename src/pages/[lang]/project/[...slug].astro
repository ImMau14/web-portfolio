---
import { getCollection, getEntry, render } from "astro:content"
import BaseLayout from "@layouts/BaseLayout.astro"
import RepoCard from "@components/RepoCard.tsx"
import { IoMdArrowRoundBack } from "react-icons/io"

import { defaultLocale } from "@content/utils"

async function getEntryOrFallback(collection: string, id: string, fallbackLang = defaultLocale) {
  const entry = await getEntry(collection, id)
  if (entry) return entry

  const fallbackId = id.replace(/^.*?\//, `${fallbackLang}/`)
  const fallbackEntry = await getEntry(collection, fallbackId)
  if (fallbackEntry) return fallbackEntry

  throw new Error(`Entry not found for ${id} and fallback ${fallbackId}`)
}

export async function getStaticPaths() {
  const entries = await getCollection("projects")

  return entries.map((e) => {
    const parts = e.id.split("/")
    const lang = parts.shift()

    if (parts[0] === "project") parts.shift()
    const slug = parts.length ? parts.join("/") : undefined
    const cleanSlug = slug?.replace(/\.md$/i, "")

    return {
      params: {
        lang,
        slug: cleanSlug,
      },
      props: { entryId: e.id },
    }
  })
}

const { lang, slug } = Astro.params as { lang: string; slug?: string }
const slugParts = slug ? slug.split("/") : []
const entryId = `${lang}/${slugParts.length ? slugParts.join("/") : "index"}`

const entry = await getEntry("projects", entryId)
if (!entry) throw new Error(`Project not found: ${entryId}`)
const { Content } = await render(entry)

const layoutEntryId = `${lang}/BaseLayout`
const layoutEntryData = await getEntryOrFallback("pages", layoutEntryId)

const projectEntryId = `${lang}/ProjectSlug`
const projectEntryData = await getEntryOrFallback("pages", projectEntryId)
---

<BaseLayout
  className="min-h-screen p-4 pt-8 md:p-16 bg-silver-1000 w-full flex gap-4 md:gap-8 flex-col items-center justify-center md:justify-start"
  baseLang={layoutEntryData.data}
  pageName={entry.data.title}
>
  <div class="flex gap-4 md:gap-8 flex-col items-center">
    <div class="flex flex-col items-start w-full md:w-[90%]">
      <span>
        <a
          class="flex flex-row gap-2 items-center font-body text-silver-400/80 hover:text-silver-300 duration-150"
          href={`/${lang}/projects`}
        >
          <IoMdArrowRoundBack className="text-xl text-green-300/80" />
          {projectEntryData.data.back}</a
        >
      </span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[400px_auto] w-[95%] md:w-[90%] gap-6 md:gap-8">
      <article class="w-full order-1 md:order-2">
        <div class="prose">
          <Content />
        </div>
      </article>

      <div class="w-full md:w-auto order-2 md:order-1 flex justify-center md:block">
        <RepoCard client:load data={entry.data} langData={projectEntryData.data} />
      </div>
    </div>
  </div>
</BaseLayout>
