---
import BaseLayout from "@layouts/BaseLayout.astro"
import { getCollection, getEntry } from "astro:content"
import type { CollectionEntry, DataEntryMap } from "astro:content"
import { FaLaptopCode } from "react-icons/fa"

import ProjectCard from "@components/ProjectCard/ProjectCard.tsx"

import { locales, defaultLocale } from "@content/utils"

export async function getStaticPaths() {
  return locales.map((lang) => ({ params: { lang } }))
}

const { lang } = Astro.params as { lang: string }

async function getEntryOrFallback<C extends keyof DataEntryMap>(
  collection: C,
  id: string,
  fallbackLang = defaultLocale,
): Promise<CollectionEntry<C> | undefined> {
  const entry = (await getEntry(collection, id)) as CollectionEntry<C> | undefined
  if (entry) return entry

  const parts = id.split("/")
  if (parts.length === 0) return undefined
  parts[0] = fallbackLang
  const fallbackId = parts.join("/")

  const fallbackEntry = (await getEntry(collection, fallbackId)) as CollectionEntry<C> | undefined
  return fallbackEntry ?? undefined
}

const all = await getCollection("projects")

let byLang = all.filter((e) => e.id.startsWith(`${lang}/`))
if (byLang.length === 0 && lang !== defaultLocale) {
  byLang = all.filter((e) => e.id.startsWith(`${defaultLocale}/`))
}

const layoutEntryId = `${lang}/BaseLayout`
const layoutEntryData = await getEntryOrFallback("pages", layoutEntryId)

const projectsEntryId = `${lang}/projects`
const projectsEntry = await getEntryOrFallback("pages", projectsEntryId)
const projectsEntryData = (projectsEntry as any)?.data ?? {
  title: "Projects",
  description: "",
  lang,
}
---

<BaseLayout
  title={projectsEntryData.pageName}
  className="flex flex-col items-center p-8 px-4 py-16 text-gray-950 md:px-24 xl:px-40 dark:text-white"
  baseLang={layoutEntryData!.data}
  pageName={projectsEntryData.pageName}
>
  <section class="flex flex-col gap-6">
    <header class="flex flex-row items-center gap-4">
      <FaLaptopCode className="text-3xl text-green-500 md:text-4xl dark:text-green-300/80" />
      <h1
        class="text-transparentmd:text-5xl bg-gradient-to-b from-gray-100 via-gray-100 to-gray-200 bg-clip-text pb-2 text-center font-heading text-4xl leading-tight md:text-start"
      >
        {projectsEntryData.header}
      </h1>
    </header>

    <p class="font-body leading-relaxed text-gray-800 dark:text-silver-500">
      {projectsEntryData.description}
    </p>

    {
      byLang.length === 0 ? (
        <p class="font-body text-gray-400">{projectsEntryData.noProjects}</p>
      ) : (
        <div class="mt-4 grid w-full grid-cols-1 gap-4 sm:grid-cols-2 md:mt-2 lg:grid-cols-3">
          {byLang.map((p) => {
            const slug = p.id.split("/")[1].split(".")[0]
            const href = `/${lang}/project/${slug}`
            return (
              <ProjectCard
                title={p.data.title}
                image={p.data.image}
                alt={p.data.alt}
                description={p.data.description}
                techs={p.data.tech}
                githubUrl={p.data.githubUrl}
                isPublic={p.data.isPublic}
                articleUrl={href}
              />
            )
          })}
        </div>
      )
    }
  </section>
</BaseLayout>
